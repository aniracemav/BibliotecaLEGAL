<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Generador · Biblioteca AV | LEGAL</title>
  <link rel="stylesheet" href="assets/styles.css"/>
  <script src="https://unpkg.com/mustache@4.2.0/mustache.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.umd.js"></script>
  <style>
    .helper{font-size:12px;color:#64748b;margin-top:4px}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="brand">Biblioteca AV | LEGAL</div>
      <div class="nav">
        <a href="index.html">Inicio</a>
        <img src="assets/pulppo-logo.png" alt="Pulppo" title="Pulppo"/>
      </div>
    </div>

    <div class="error" id="errorBox"></div>

    <div class="card">
      <div class="section-title">Selecciona la plantilla</div>
      <select id="templateSelect" class="input">
        <option value="">— Selecciona —</option>
      </select>
      <div class="helper">La plantilla de Promesa genera un <strong>.docx</strong> con estilo jurídico. Para Montserrat, el usuario debe tener la fuente instalada.</div>
    </div>

    <div class="card" id="formCard">
      <div class="section-title">Variables</div>
      <form id="varForm"></form>
    </div>

    <div class="card">
      <div class="section-title">Vista previa</div>
      <div id="preview" class="input" style="min-height:160px;height:auto"></div>
      <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
        <button id="downloadDoc" class="button" disabled>Descargar .doc</button>
        <button id="downloadPdf" class="button" disabled>Descargar PDF</button>
        <button id="downloadDocx" class="button" disabled>Descargar .docx</button>
        <button id="copyText" class="button secondary" disabled>Copiar texto</button>
      </div>
    </div>
  </div>

  <script>
    let templatesIndex = [];
    let currentTpl = null;
    let currentVars = {};

    const $sel = document.getElementById('templateSelect');
    const $form = document.getElementById('varForm');
    const $preview = document.getElementById('preview');
    const $btnDoc = document.getElementById('downloadDoc');
    const $btnPdf = document.getElementById('downloadPdf');
    const $btnDocx = document.getElementById('downloadDocx');
    const $btnCopy = document.getElementById('copyText');
    const $error = document.getElementById('errorBox');

    function showError(msg){ $error.textContent = msg; $error.style.display = 'block'; }
    function hideError(){ $error.style.display = 'none'; }

    function option(t){ return `<option value="${t.id}">${t.name} · ${t.jurisdiction||''}</option>`; }

    function fieldHTML(v){
      const base = `<label style="display:block;font-size:12px;color:#475569;margin:6px 0 4px">${v.label}</label>`;
      if (v.type === 'textarea') return base + `<textarea id="${v.key}" rows="4" class="input"></textarea>`;
      if (v.type === 'number') return base + `<input type="number" id="${v.key}" class="input"/>`;
      if (v.type === 'date') return base + `<input type="date" id="${v.key}" class="input"/>`;
      return base + `<input type="text" id="${v.key}" class="input"/>`;
    }

    function buildForm(tpl){
      if (!tpl){ $form.innerHTML = '<em>Selecciona una plantilla</em>'; return; }
      $form.innerHTML = (tpl.variables||[]).map(fieldHTML).join('<div style="height:8px"></div>') + `<div style="margin-top:12px"><button class="button" id="renderBtn">Renderizar</button></div>`;
      $form.onsubmit = onSubmit;
    }

    function collectVars(){
      currentVars = {};
      (currentTpl.variables || []).forEach(v => {
        const el = document.getElementById(v.key);
        currentVars[v.key] = (el && el.value) || '';
      });
    }

    function onSubmit(e){
      e.preventDefault();
      collectVars();
      renderPreview();
    }

    function textToHtml(text){
      const esc = text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      return esc.replace(/\n\n/g,'</p><p>').replace(/\n/g,'<br/>');
    }

    function afterRender(filledText) {
      $preview.innerHTML = '<p>' + textToHtml(filledText) + '</p>';
      [$btnDoc,$btnPdf,$btnDocx,$btnCopy].forEach(b => b.disabled = false);
      $btnDoc.onclick  = () => downloadDoc(filledText, currentTpl.name);
      $btnPdf.onclick  = () => downloadPdf(filledText, currentTpl.name);
      $btnCopy.onclick = () => navigator.clipboard.writeText(filledText);
    }

    function renderPreview(){
      hideError();
      if (!currentTpl) return;

      if (currentTpl.path && currentTpl.path.startsWith('docx:')){
        const id = currentTpl.path.split(':')[1];
        const sketch = buildSketchTextForDocx(id, currentVars);
        afterRender(sketch);
        $btnDocx.onclick = () => generateDocxFor(id, currentVars, currentTpl.name);
        return;
      }

      fetch(currentTpl.path)
        .then(r => { if (!r.ok) throw new Error('No se encontró la plantilla: '+currentTpl.path); return r.text(); })
        .then(raw => {
          const filled = Mustache.render(raw, currentVars);
          afterRender(filled);
        })
        .catch(err => showError(err.message));
    }

    function downloadDoc(text, name){
      const content = `<!DOCTYPE html><html><head><meta charset="utf-8"></head><body><pre>${text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</pre></body></html>`;
      const blob = new Blob([content], {type:'application/msword'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = (name||'documento') + '.doc';
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      URL.revokeObjectURL(a.href);
    }

    async function downloadPdf(text, name){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({unit:'pt', format:'letter'});
      const margin = 56;
      const maxWidth = 612 - margin*2;
      const lines = doc.splitTextToSize(text, maxWidth);
      let y = margin;
      for (let i=0;i<lines.length;i++){
        if (y > 756 - margin){ doc.addPage(); y = margin; }
        doc.text(lines[i], margin, y);
        y += 16;
      }
      doc.save((name||'documento') + '.pdf');
    }

    // Build filename with vendor and date
    function sanitize(s){
      return (s || 'Vendedor')
        .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
        .replace(/[^a-zA-Z0-9 _-]/g,'').trim().replace(/\s+/g,'_')
        .slice(0,40);
    }
    function buildDocxFilename(vars){
      const vendor = sanitize(vars.vendedor_nombre);
      const d = new Date().toISOString().slice(0,10);
      return `Promesa_Compraventa_${vendor}_${d}.docx`;
    }

    // Preview text for DOCX template
    function buildSketchTextForDocx(id, v){
      if (id !== 'mx_promesa_cv_001') return '';
      return [
        'CONTRATO DE PROMESA DE COMPRAVENTA DE INMUEBLE',
        'Ciudad: ' + (v.ciudad || ''),
        'Fecha: ' + (v.diafirma || ''),
        '',
        'Promitente Vendedor: ' + (v.vendedor_nombre || ''),
        'Promitente Comprador: ' + (v.comprador_nombre || ''),
        '',
        'Inmueble: ' + (v.inmueble_domicilio || ''),
        'Precio total (MXN): ' + (v.precio_total || ''),
        '',
        'Cláusulas: ad corpus; pena convencional 10%.'
      ].join('\n');
    }

    // DOCX generator (styled; note: true Word "form controls" need OOXML SDT, que podemos incluir en versión 2)
    async function generateDocxFor(id, v, name){
      if (id !== 'mx_promesa_cv_001') return;
      const { Document, Packer, Paragraph, TextRun, HeadingLevel, AlignmentType } = docx;

      const font = 'Montserrat';
      const baseSize = 15; // half-points => 7.5pt

      function run(txt, opts={}){
        return new TextRun(Object.assign({ text: txt, font, size: baseSize }, opts));
      }
      function p(txt){ return new Paragraph({ children: [ run(txt) ], spacing:{ after: 120 } }); }
      function pb(txt){ return new Paragraph({ children: [ run(txt, { bold:true }) ], spacing:{ after: 120 } }); }
      function center(txt, lvl){
        return new Paragraph({ children:[ run(txt, { bold:true }) ], alignment: AlignmentType.CENTER, spacing:{ after: 200 }, heading: lvl });
      }

      // Body (extracto estructurado del texto compartido; las variables se insertan)
      const doc = new Document({
        styles: { default: { document: { run: { font, size: baseSize } } } },
        sections: [{
          properties: { page: { margin: { top: 1440, right: 1440, bottom: 1440, left: 1440 } } },
          children: [
            center('CONTRATO DE PROMESA DE COMPRAVENTA DE INMUEBLE', HeadingLevel.TITLE),
            new Paragraph({ children: [ run(`Ciudad: ${v.ciudad||''}`, { bold:true }), run('    ·    '), run(`Fecha: ${v.diafirma||''}`, { bold:true }) ], alignment: AlignmentType.CENTER, spacing:{ after: 200 } }),

            center('D E C L A R A C I O N E S', HeadingLevel.HEADING_2),
            pb(`El PROMITENTE VENDEDOR ${v.vendedor_nombre||''}, declara que:`),
            p(`Es una persona física con capacidad legal, plena y suficiente para celebrar el presente CONTRATO y obligarse en términos del mismo.`),
            p(`Su estado civil actual es: ${v.vendedor_estado_civil||''}.`),
            p(`Se identifica en este acto con ${v.vendedor_identificacion||''} número ${v.vendedor_ident_num||''}.`),
            p(`Cuenta con RFC: ${v.vendedor_rfc||''}.`),
            p(`Su domicilio para efectos legales es: ${v.vendedor_domicilio||''}.`),
            p(`Es legítimo propietario del INMUEBLE ubicado en: ${v.inmueble_domicilio||''}.`),

            pb(`El PROMITENTE COMPRADOR ${v.comprador_nombre||''}, declara que:`),
            p(`Es una persona física con capacidad legal, plena y suficiente para celebrar el presente CONTRATO y obligarse en términos del mismo.`),
            p(`Su estado civil actual es: ${v.comprador_estado_civil||''}.`),
            p(`Se identifica en este acto con ${v.comprador_identificacion||''} número ${v.comprador_ident_num||''}.`),
            p(`Cuenta con RFC: ${v.comprador_rfc||''}.`),
            p(`Su domicilio para efectos legales es: ${v.comprador_domicilio||''}.`),

            center('C L Á U S U L A S', HeadingLevel.HEADING_2),
            pb('PRIMERA. Objeto'),
            p(`Las PARTES prometen celebrar un CONTRATO DE COMPRAVENTA en escritura pública dentro de ${v.dias_plazo||'___'} días naturales a partir de esta fecha.`),
            p(`El PROMITENTE VENDEDOR venderá el INMUEBLE al PROMITENTE COMPRADOR por el precio de $${v.precio_total||''} M.N. (“EL PRECIO”).`),

            pb('SEGUNDA. Especificaciones del CONTRATO DE COMPRAVENTA.'),
            p(`Objeto: Inmueble ubicado en ${v.inmueble_domicilio||''}.`),
            p(`Precio: $${v.precio_total||''} M.N. pagadero a la celebración del CONTRATO DE COMPRAVENTA.`),
            p(`Prenda: $${v.prenda_total||'N/A'}.`),
            p(`Abono 1: ${v.abono1_monto||'N/A'} el ${v.abono1_fecha||'N/A'}. Abono 2: ${v.abono2_monto||'N/A'} el ${v.abono2_fecha||'N/A'}.`),
            p(`Datos bancarios vendedor: ${v.datos_bancarios||'N/A'}.`),
            p('La compraventa se pacta “ad corpus”; el precio no se ajustará por medidas o cabidas.'),

            pb('TERCERA. Vigencia.'),
            p(`Escritura pública dentro del plazo señalado; Notaría: ${v.notaria||'N/A'}. Escritura previa: ${v.escritura_previa||'N/A'}.`),

            pb('CUARTA. Incumplimiento y PENA CONVENCIONAL.'),
            p('La parte incumplida pagará a la otra una pena convencional equivalente al 10% del PRECIO total, sin perjuicio de daños y perjuicios.'),

            pb('QUINTA. Cesión.'),
            p('Ninguna parte podrá ceder sus derechos u obligaciones sin consentimiento previo y por escrito de la otra.'),

            pb('SEXTA. Notificaciones.'),
            p('Las notificaciones deberán realizarse por escrito en los domicilios y medios de contacto designados por las PARTES.'),

            pb('SÉPTIMA. Acuerdo total.'),
            p('Este CONTRATO contiene el acuerdo total entre las PARTES; sustituye cualquier entendimiento previo.'),

            pb('OCTAVA. Leyes aplicables y jurisdicción.'),
            p(`Se aplican las leyes de ${v.ciudad||''}, México; los tribunales competentes de ${v.ciudad||''}.`),

            center('F I R M A S', HeadingLevel.HEADING_2),
            p('_____________________________________________'),
            p(`${v.comprador_nombre||'Promitente Comprador'}`),
            p(''),
            p('_____________________________________________'),
            p(`${v.vendedor_nombre||'Promitente Vendedor'}`)
          ]
        }]
      });

      const blob = await Packer.toBlob(doc);
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = buildDocxFilename(v);
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      URL.revokeObjectURL(a.href);
    }

    function onTemplateChange(){
      const id = $sel.value;
      currentTpl = templatesIndex.find(x => x.id === id);
      buildForm(currentTpl);
      $preview.innerHTML = '';
      [$btnDoc,$btnPdf,$btnDocx,$btnCopy].forEach(b => b.disabled = true);
    }

    async function loadTemplates(){
      try{
        const r = await fetch('data/templates.json');
        if (!r.ok) throw new Error('No se pudo cargar data/templates.json');
        const json = await r.json();
        templatesIndex = json.templates || [];
        if (templatesIndex.length === 0) throw new Error('No hay plantillas en templates.json');
        $sel.innerHTML = '<option value="">— Selecciona —</option>' + templatesIndex.map(option).join('');
        $sel.selectedIndex = 1; // autoselect first available
        onTemplateChange();
      }catch(e){ showError(e.message); }
    }

    $sel.addEventListener('change', onTemplateChange);
    loadTemplates();
  </script>
</body>
</html>
