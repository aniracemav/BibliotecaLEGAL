<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Generador · Biblioteca AV | LEGAL</title>
  <link rel="stylesheet" href="assets/styles.css"/>
  <script src="https://unpkg.com/mustache@4.2.0/mustache.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="brand">Biblioteca AV | LEGAL</div>
      <div class="nav"><a href="index.html">Inicio</a><img src="assets/pulppo-logo.png" alt="Pulppo" title="Pulppo"/></div>
    </div>

    <div class="card">
      <div class="section-title">Selecciona la plantilla</div>
      <select id="templateSelect" class="input"></select>
      <div class="helper">La Promesa de Compraventa descarga un <strong>.docx</strong> ya maquetado (Montserrat 7.5). Campos editables se llenan en Word.</div>
    </div>

    <div class="card" id="formCard">
      <div class="section-title">Variables básicas para el nombre del archivo</div>
      <form id="varForm"></form>
    </div>

    <div class="card">
      <div class="section-title">Acciones</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="downloadDocx" class="button" disabled>Descargar .docx</button>
      </div>
    </div>

    <div class="card">
      <div class="section-title">Admin</div>
      <p class="helper">Copia editable del DOCX original: <a href="templates/_edicion/MX_PROMESA_original.docx" download>Descargar desprotegido</a></p>
    </div>
  </div>

  <script>
    let templatesIndex = [];
    let currentTpl = null;
    let currentVars = {};

    const $sel = document.getElementById('templateSelect');
    const $form = document.getElementById('varForm');
    const $btnDocx = document.getElementById('downloadDocx');

    function option(t){ return `<option value="${t.id}">${t.name} · ${t.jurisdiction||''}</option>`; }

    function fieldHTML(v){
      const base = `<label style="display:block;font-size:12px;color:#475569;margin:6px 0 4px">${v.label}</label>`;
      return base + `<input type="text" id="${v.key}" class="input"/>`;
    }

    function buildForm(tpl){
      const html = (tpl.variables||[]).map(fieldHTML).join('<div style="height:8px"></div>');
      $form.innerHTML = html || '<em>No requiere variables</em>';
      $form.oninput = () => {
        currentVars = {};
        (tpl.variables||[]).forEach(v => currentVars[v.key] = (document.getElementById(v.key)?.value)||'');
      };
    }

    function sanitize(s){
      return (s || 'Vendedor')
        .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
        .replace(/[^a-zA-Z0-9 _-]/g,'')
        .trim().replace(/\s+/g,'_').slice(0,40);
    }
    function buildDocxFilename(vars){
      const vendor = sanitize(vars.vendedor_nombre);
      const d = new Date().toISOString().slice(0,10);
      return `Promesa_Compraventa_${vendor}_${d}.docx`;
    }

    function onTemplateChange(){
      const id = $sel.value;
      currentTpl = templatesIndex.find(x => x.id === id);
      buildForm(currentTpl);
      $btnDocx.disabled = false;
    }

    async function loadTemplates(){
      const r = await fetch('data/templates.json');
      const json = await r.json();
      templatesIndex = json.templates;
      $sel.innerHTML = templatesIndex.map(option).join('');
      $sel.selectedIndex = 0; onTemplateChange();
    }

    $btnDocx.onclick = () => {
      if (!currentTpl) return;
      // If "static:" -> direct download
      const path = currentTpl.path || '';
      if (path.startsWith('static:')){
        const url = path.replace('static:', '');
        const a = document.createElement('a');
        a.href = url;
        a.download = buildDocxFilename(currentVars);
        document.body.appendChild(a); a.click(); a.remove();
      }
    };

    loadTemplates();
  </script>
</body>
</html>
